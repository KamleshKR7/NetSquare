---
  - hosts: all
    become: true
    tasks:
      - name: Install CA certificates
        yum:
          name: ca-certificates
          state: present

      - name: Update the CA trust store
        command: update-ca-trust
        when: ansible_facts['os_family'] == "RedHat"

      - name: Copy custom CA certificate
        copy:
          src: /home/ansadmin/NetSquare/CA1.crt
          dest: /etc/pki/ca-trust/source/anchors/CA1.crt
          mode: '0644'

      - name: Update CA store with custom CA
        command: update-ca-trust
      
      - name: Check if the custom CA certificate has expired on RedHat-based systems
        command: "openssl x509 -noout -in /etc/pki/ca-trust/source/anchors/CA1.crt -checkend 0"
        register: cert_check_redhat
        when: ansible_facts['os_family'] == "RedHat"

      - name: Fail if the custom CA certificate has expired on RedHat-based systems
        fail:
          msg: "The custom CA certificate has expired!"
        when: cert_check_redhat.rc != 0

