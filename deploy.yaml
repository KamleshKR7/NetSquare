---
  - hosts: all
    become: true
    vars_files:
      - data.yml
      - secret.yml
    tasks:
      - name: Create /opt/example directory
        file:
          path: "{{ Deployment_Folder }}"
          state: directory
          mode: '0755'

      - name: Create /opt/example/instance
        file:
          path: "{{ Instance_Path }}"
          state: directory
          mode: '0755'

      - name: Copy the run.sh script to the target host
        copy:
          src: /home/ansadmin/NetSquare/run.sh
          dest: "{{ Deployment_Folder }}/run.sh"
          mode: '0755'

      - name: Copy the config.py script to the target host
        copy:
          dest: "{{ Instance_Path }}/config.py"
          content: |
            SECRET_KEY = "{{ SECRET_KEY }}"
            DB_PATH = "{{ DB_PATH }}"
          mode: '0755'

      - name: Ensure correct permissions for config.py
        file:
          path: "{{ Instance_Path }}/config.py"
          owner: root
          group: root
          mode: '0600'

      - name: Set environment variables
        shell: |
          export "deployment_folder={{ Deployment_Folder }}"
          export "port={{ port }} "
                      
      - name: Install Python3 and pip (RedHat-based)
        yum:
          name:
            - python3
            - python3-pip
            - python3-virtualenv
          state: present
        when: ansible_facts['os_family'] == "RedHat"

      - name: Copy Flask application wheel file to the target system
        copy:
          src: "/home/ansadmin/NetSquare/{{ Wheel }}"
          dest: "/opt/example/{{ Wheel }}"
          mode: '0644'

      - name: Create a Python virtual environment
        command: python3 -m venv /opt/example/venv
        args:
          creates: /opt/example/venv/bin/activate

      - name: Install Flask app dependencies from wheel or requirements.txt
        command: /opt/example/venv/bin/pip install "/opt/example/{{ Wheel }}"
        args:
          creates: /opt/example/venv/lib/python*/site-packages/test
       
      - name: Copy the example.service file to the target host
        copy:
          src: /home/ansadmin/NetSquare/example.service
          dest: /etc/systemd/system/example.service
          mode: '0755'

      - name: Reload systemd daemon
        command: systemctl daemon-reload

      - name: Start and enable example.service
        systemd:
          name: example.service
          enabled: true
          state: started

