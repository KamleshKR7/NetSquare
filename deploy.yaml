---
  - hosts: all
    become: true
    tasks:
      
      - name: Create /opt/example directory
        file:
          path: /opt/example
          state: directory
          mode: '0755'

      - name: Create /opt/example/instance
        file:
          path: /opt/example/instance
          state: directory
          mode: '0755'

      - name: Copy the run.sh script to the target host
        copy:
          src: /home/ansadmin/NetSquare/run.sh
          dest: /opt/example/run.sh
          mode: '0755'

      - name: Copy the config.py script to the target host
        copy:
          src: /home/ansadmin/NetSquare/config.py
          dest: /opt/example/instance/config.py
          mode: '0755'
                                
      - name: Install Python3 and pip (RedHat-based)
        yum:
          name:
            - python3
            - python3-pip
            - python3-virtualenv
          state: present
        when: ansible_facts['os_family'] == "RedHat"

      - name: Copy Flask application wheel file to the target system
        copy:
          src: /home/ansadmin/NetSquare/Example-1.1.2-py3-none-any.whl
          dest: /opt/example/Example-1.1.2-py3-none-any.whl
          mode: '0644'

      - name: Create a Python virtual environment
        command: python3 -m venv /opt/example/venv
        args:
          creates: /opt/example/venv/bin/activate

      - name: Install Flask app dependencies from wheel or requirements.txt
        command: /opt/example/venv/bin/pip install /opt/example/Example-1.1.2-py3-none-any.whl
        args:
          creates: /opt/example/venv/lib/python*/site-packages/test
       
      - name: Copy the example.service file to the target host
        copy:
          src: /home/ansadmin/NetSquare/example.service
          dest: /etc/systemd/system/example.service
          mode: '0755'
        notify: Reload systemd daemon

    handlers:
      - name: Reload systemd daemon
        command: systemctl daemon-reload

      - name: Start and enable example.service
        systemd:
          name: example.service
          enabled: true
          state: started
        when: ansible_service_mgr == "systemd"

